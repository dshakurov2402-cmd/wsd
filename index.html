<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Abol Telegram</title>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #0e1621; color: white; margin: 0; display: flex; justify-content: center; align-items: center; height: 100vh; }
        #auth, #chat { background: #17212b; width: 100%; max-width: 400px; height: 600px; display: flex; flex-direction: column; border-radius: 0; box-shadow: 0 0 20px rgba(0,0,0,0.5); }
        .hidden { display: none !important; }
        
        /* Шапка */
        .header { background: #242f3d; padding: 15px; display: flex; align-items: center; font-weight: bold; font-size: 18px; border-bottom: 1px solid #0e1621; }
        
        /* Окно входа */
        .auth-content { padding: 40px 20px; text-align: center; flex: 1; }
        input { width: 100%; padding: 12px; margin: 10px 0; border: 1px solid #242f3d; border-radius: 8px; background: #1f2936; color: white; box-sizing: border-box; }
        button { width: 100%; padding: 12px; background: #50a2e3; border: none; color: white; border-radius: 8px; cursor: pointer; font-weight: bold; margin-top: 10px; }
        
        /* Сообщения */
        #messages { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; background: url('https://user-images.githubusercontent.com/15075759/28719144-86dc0f70-73b1-11e7-911d-60d70fcded21.png'); background-size: cover; }
        .msg { margin-bottom: 10px; padding: 8px 12px; border-radius: 12px; max-width: 75%; font-size: 14px; position: relative; line-height: 1.4; }
        .my-msg { align-self: flex-end; background: #2b5278; border-bottom-right-radius: 2px; }
        .friend-msg { align-self: flex-start; background: #182533; border-bottom-left-radius: 2px; }
        
        /* Поле ввода */
        .input-area { background: #17212b; padding: 10px; display: flex; gap: 10px; }
        .input-area input { margin: 0; border-radius: 20px; padding: 10px 15px; }
        .input-area button { width: auto; margin: 0; border-radius: 50%; width: 40px; height: 40px; padding: 0; }
    </style>
</head>
<body>

    <div id="auth">
        <div class="header">Abol Messenger</div>
        <div class="auth-content">
            <img src="https://upload.wikimedia.org/wikipedia/commons/8/82/Telegram_logo.svg" width="80" style="margin-bottom: 20px;">
            <input type="text" id="username" placeholder="Ваш юзернейм">
            <input type="text" id="friendName" placeholder="Кому хотите написать?">
            <button onclick="login()">НАЧАТЬ ОБЩЕНИЕ</button>
        </div>
    </div>

    <div id="chat" class="hidden">
        <div class="header" id="chatWith">Чат</div>
        <div id="messages"></div>
        <div class="input-area">
            <input type="text" id="messageInput" placeholder="Написать сообщение...">
            <button onclick="sendMessage()">➤</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, query, orderBy, onSnapshot, serverTimestamp, where } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // Твои ключи Firebase (Дамир, они уже вставлены!)
        const firebaseConfig = {
            apiKey: "AIzaSyBz8fnaJ_mpCE5Vv83doxBb6nTybDSBmlI",
            authDomain: "kaka-chat-39bb6.firebaseapp.com",
            projectId: "kaka-chat-39bb6",
            storageBucket: "kaka-chat-39bb6.firebasestorage.app",
            messagingSenderId: "927391255601",
            appId: "1:927391255601:web:1f83128108dc1ca2831910"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        let currentUser = "";
        let chatID = "";

        window.login = () => {
            const name = document.getElementById('username').value.trim().toLowerCase();
            const friend = document.getElementById('friendName').value.trim().toLowerCase();
            
            if (name && friend) {
                currentUser = name;
                chatID = [name, friend].sort().join("_");
                document.getElementById('chatWith').innerText = friend;
                document.getElementById('auth').classList.add('hidden');
                document.getElementById('chat').classList.remove('hidden');
                loadMessages();
            }
        };

        window.sendMessage = async () => {
            const textInput = document.getElementById('messageInput');
            const text = textInput.value;
            if (text) {
                await addDoc(collection(db, "messages"), {
                    user: currentUser,
                    room: chatID,
                    text: text,
                    createdAt: serverTimestamp()
                });
                textInput.value = "";
            }
        };

        function loadMessages() {
            const q = query(
                collection(db, "messages"), 
                where("room", "==", chatID),
                orderBy("createdAt", "asc")
            );

            onSnapshot(q, (snapshot) => {
                const msgDiv = document.getElementById('messages');
                msgDiv.innerHTML = "";
                snapshot.forEach((doc) => {
                    const data = doc.data();
                    const isMy = data.user === currentUser;
                    const cssClass = isMy ? "my-msg" : "friend-msg";
                    msgDiv.innerHTML += `<div class="msg ${cssClass}">${data.text}</div>`;
                });
                msgDiv.scrollTop = msgDiv.scrollHeight;
            });
        }
        
        // Отправка по Enter
        document.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') sendMessage();
        });
    </script>
</body>
</html>
